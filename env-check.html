<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç¯å¢ƒå˜é‡æ£€æŸ¥ - M-Profile Lab</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      color: white;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 30px;
      backdrop-filter: blur(10px);
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .status-card {
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      padding: 20px;
      margin: 15px 0;
      border-left: 5px solid #4caf50;
    }
    .status-card.error {
      border-left-color: #f44336;
      background: rgba(244, 67, 54, 0.2);
    }
    .status-card.warning {
      border-left-color: #ff9800;
      background: rgba(255, 152, 0, 0.2);
    }
    .env-var {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin: 5px 0;
      background: rgba(0,0,0,0.2);
      border-radius: 5px;
    }
    .status-badge {
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8em;
      font-weight: bold;
    }
    .status-ok { background: #4caf50; }
    .status-error { background: #f44336; }
    .status-warning { background: #ff9800; }
    .instructions {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
    }
    .instructions h3 {
      margin-top: 0;
      color: #ffd700;
    }
    .instructions ol {
      padding-left: 20px;
    }
    .instructions li {
      margin: 10px 0;
      line-height: 1.6;
    }
    .code-block {
      background: rgba(0,0,0,0.3);
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      overflow-x: auto;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    .btn-primary {
      background: #1976d2;
      color: white;
    }
    .btn-primary:hover {
      background: #1565c0;
    }
    .btn-secondary {
      background: #4caf50;
      color: white;
    }
    .btn-secondary:hover {
      background: #45a049;
    }
    .btn-warning {
      background: #ff9800;
      color: white;
    }
    .btn-warning:hover {
      background: #f57c00;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .btn:active {
      transform: scale(0.98);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ ç¯å¢ƒå˜é‡æ£€æŸ¥å·¥å…·</h1>
    
    <div id="status-container">
      <div class="status-card">
        <h3>ğŸ“Š ç¯å¢ƒå˜é‡çŠ¶æ€</h3>
        <div id="env-vars"></div>
      </div>
    </div>

    <div class="action-buttons">
      <button class="btn btn-primary" id="check-env-btn">é‡æ–°æ£€æŸ¥ç¯å¢ƒ</button>
      <button class="btn btn-secondary" id="test-db-btn">æµ‹è¯•æ•°æ®åº“è¿æ¥</button>
      <button class="btn btn-warning" id="show-instructions-btn">æ˜¾ç¤ºè®¾ç½®æŒ‡å—</button>
    </div>

    <div id="instructions" class="instructions" style="display: none;">
      <h3>ğŸ“‹ æ•°æ®åº“è®¾ç½®æŒ‡å—</h3>
      <ol>
        <li>
          <strong>åˆ›å»º Supabase é¡¹ç›®</strong><br>
          è®¿é—® <a href="https://supabase.com" target="_blank" style="color: #ffd700;">Supabase å®˜ç½‘</a> åˆ›å»ºå…è´¹é¡¹ç›®
        </li>
        <li>
          <strong>è·å–è¿æ¥ä¿¡æ¯</strong><br>
          åœ¨é¡¹ç›®è®¾ç½®ä¸­æ‰¾åˆ°ä»¥ä¸‹ä¿¡æ¯ï¼š
          <ul>
            <li>é¡¹ç›® URL (Project URL)</li>
            <li>åŒ¿åå¯†é’¥ (Anon Key)</li>
          </ul>
        </li>
        <li>
          <strong>é…ç½®ç¯å¢ƒå˜é‡</strong><br>
          åˆ›å»º <code>.env</code> æ–‡ä»¶åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼š
          <div class="code-block">
VITE_SUPABASE_URL=your-project-url
VITE_SUPABASE_ANON_KEY=your-anon-key
          </div>
        </li>
        <li>
          <strong>æ‰§è¡Œæ•°æ®åº“è„šæœ¬</strong><br>
          åœ¨ Supabase æ§åˆ¶å°ä¸­ä¾æ¬¡æ‰§è¡Œä»¥ä¸‹ SQL æ–‡ä»¶ï¼š
          <ul>
            <li><code>create_main_tables.sql</code></li>
            <li><code>create_test_counters_table.sql</code></li>
            <li><code>create_admin_system.sql</code></li>
            <li><code>create_replies_table.sql</code></li>
          </ul>
        </li>
        <li>
          <strong>é‡å¯å¼€å‘æœåŠ¡å™¨</strong><br>
          é‡æ–°å¯åŠ¨ Vite å¼€å‘æœåŠ¡å™¨ä»¥åº”ç”¨æ–°çš„ç¯å¢ƒå˜é‡
        </li>
      </ol>
    </div>

    <div id="test-results" style="display: none;">
      <!-- æµ‹è¯•ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
    </div>
  </div>

  <script type="module">
    // å°†å‡½æ•°å®šä¹‰åœ¨å…¨å±€ä½œç”¨åŸŸ
    window.checkEnvironment = function() {
      const envVars = [
        { name: 'VITE_SUPABASE_URL', value: import.meta.env.VITE_SUPABASE_URL },
        { name: 'VITE_SUPABASE_ANON_KEY', value: import.meta.env.VITE_SUPABASE_ANON_KEY }
      ];

      const container = document.getElementById('env-vars');
      container.innerHTML = '';

      envVars.forEach(envVar => {
        const div = document.createElement('div');
        div.className = 'env-var';
        
        const isConfigured = !!envVar.value;
        const statusClass = isConfigured ? 'status-ok' : 'status-error';
        const statusText = isConfigured ? 'å·²é…ç½®' : 'æœªé…ç½®';
        
        div.innerHTML = `
          <span><strong>${envVar.name}</strong></span>
          <span class="status-badge ${statusClass}">${statusText}</span>
        `;
        
        container.appendChild(div);
      });

      // æ€»ä½“çŠ¶æ€
      const allConfigured = envVars.every(envVar => !!envVar.value);
      const statusCard = document.querySelector('.status-card');
      
      if (allConfigured) {
        statusCard.className = 'status-card';
        statusCard.querySelector('h3').innerHTML = 'âœ… ç¯å¢ƒå˜é‡é…ç½®æ­£å¸¸';
      } else {
        statusCard.className = 'status-card error';
        statusCard.querySelector('h3').innerHTML = 'âŒ ç¯å¢ƒå˜é‡é…ç½®ä¸å®Œæ•´';
      }
    }

    // ç®€å•çš„ç¯å¢ƒå˜é‡æµ‹è¯•ï¼ˆä¸ä¾èµ–å¤–éƒ¨åº“ï¼‰
    window.testBasicConnection = function() {
      const resultsDiv = document.getElementById('test-results');
      resultsDiv.style.display = 'block';
      
      const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
      const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
      
      let html = '<div class="status-card">';
      
      if (!supabaseUrl || !supabaseAnonKey) {
        html += '<h3>âŒ ç¯å¢ƒå˜é‡æ£€æŸ¥</h3>';
        html += '<p>VITE_SUPABASE_URL: ' + (supabaseUrl ? 'å·²é…ç½®' : 'æœªé…ç½®') + '</p>';
        html += '<p>VITE_SUPABASE_ANON_KEY: ' + (supabaseAnonKey ? 'å·²é…ç½®' : 'æœªé…ç½®') + '</p>';
        html += '<p style="color: #ff9800;">è¯·å…ˆé…ç½®ç¯å¢ƒå˜é‡</p>';
      } else {
        html += '<h3>âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥</h3>';
        html += '<p>VITE_SUPABASE_URL: å·²é…ç½®</p>';
        html += '<p>VITE_SUPABASE_ANON_KEY: å·²é…ç½®</p>';
        html += '<p>ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®ï¼Œå¯ä»¥è¿›è¡Œæ•°æ®åº“è¿æ¥æµ‹è¯•</p>';
      }
      
      html += '</div>';
      resultsDiv.innerHTML = html;
    }

    // æµ‹è¯•æ•°æ®åº“è¿æ¥
    window.testDatabaseConnection = async function() {
      const resultsDiv = document.getElementById('test-results');
      const testBtn = document.getElementById('test-db-btn');
      
      resultsDiv.style.display = 'block';
      resultsDiv.innerHTML = '<div class="status-card">ğŸ”„ æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...</div>';
      testBtn.disabled = true;
      testBtn.textContent = 'æµ‹è¯•ä¸­...';

      try {
        // æ£€æŸ¥ç¯å¢ƒå˜é‡
        const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
        const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
        
        if (!supabaseUrl || !supabaseAnonKey) {
          throw new Error('ç¯å¢ƒå˜é‡æœªé…ç½®ï¼šVITE_SUPABASE_URL æˆ– VITE_SUPABASE_ANON_KEY ç¼ºå¤±');
        }

        // ç›´æ¥æµ‹è¯•æ•°æ®åº“è¿æ¥
        const { createClient } = await import('https://esm.sh/@supabase/supabase-js');
        const supabase = createClient(supabaseUrl, supabaseAnonKey);
        
        // æµ‹è¯•åŸºæœ¬è¿æ¥
        const { data, error } = await supabase
          .from('users')
          .select('id')
          .limit(1);

        let html = '<div class="status-card">';
        
        if (error) {
          html += '<h3>âŒ æ•°æ®åº“è¿æ¥å¤±è´¥</h3>';
          html += '<p>è¿æ¥çŠ¶æ€ï¼šå¤±è´¥</p>';
          html += `<p style="color: #f44336;">é”™è¯¯ä¿¡æ¯ï¼š${error.message}</p>`;
        } else {
          html += '<h3>âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ</h3>';
          html += '<p>è¿æ¥çŠ¶æ€ï¼šæ­£å¸¸</p>';
          html += '<p>ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®</p>';
          
          // å°è¯•æ£€æŸ¥æ›´å¤šè¡¨
          const tables = ['users', 'test_records', 'test_results'];
          html += '<h4>æ•°æ®è¡¨æ£€æŸ¥ï¼š</h4>';
          
          for (const table of tables) {
            try {
              const { data: tableData, error: tableError } = await supabase
                .from(table)
                .select('*')
                .limit(1);
              
              if (tableError) {
                html += `<p>âŒ ${table}: ${tableError.message}</p>`;
              } else {
                html += `<p>âœ… ${table}: æ­£å¸¸ (${tableData ? tableData.length : 0} æ¡è®°å½•)</p>`;
              }
            } catch (e) {
              html += `<p>âŒ ${table}: æ£€æŸ¥å¤±è´¥</p>`;
            }
          }
        }
        
        html += '</div>';
        resultsDiv.innerHTML = html;
        
      } catch (error) {
        resultsDiv.innerHTML = `
          <div class="status-card error">
            <h3>âŒ æµ‹è¯•å¤±è´¥</h3>
            <p>é”™è¯¯ä¿¡æ¯ï¼š${error.message}</p>
            <p>è¯·ç¡®ä¿ï¼š</p>
            <ul>
              <li>ç¯å¢ƒå˜é‡å·²æ­£ç¡®é…ç½®</li>
              <li>ç½‘ç»œè¿æ¥æ­£å¸¸</li>
              <li>Supabase æœåŠ¡å¯è®¿é—®</li>
            </ul>
            <p><button class="btn btn-secondary" onclick="testBasicConnection()">å°è¯•ç®€å•æµ‹è¯•</button></p>
          </div>
        `;
        console.error('æ•°æ®åº“æµ‹è¯•å¤±è´¥:', error);
      } finally {
        testBtn.disabled = false;
        testBtn.textContent = 'æµ‹è¯•æ•°æ®åº“è¿æ¥';
      }
    }

    // æ˜¾ç¤ºè®¾ç½®æŒ‡å—
    window.showSetupInstructions = function() {
      const instructions = document.getElementById('instructions');
      instructions.style.display = instructions.style.display === 'none' ? 'block' : 'none';
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    document.addEventListener('DOMContentLoaded', () => {
      console.log('ç¯å¢ƒå˜é‡æ£€æŸ¥å·¥å…·å·²åŠ è½½');
      console.log('å½“å‰ç¯å¢ƒå˜é‡çŠ¶æ€:', {
        VITE_SUPABASE_URL: !!import.meta.env.VITE_SUPABASE_URL,
        VITE_SUPABASE_ANON_KEY: !!import.meta.env.VITE_SUPABASE_ANON_KEY
      });
      
      // æ£€æŸ¥æ˜¯å¦åœ¨å¼€å‘ç¯å¢ƒä¸­
      if (typeof import.meta.env !== 'undefined') {
        console.log('Vite ç¯å¢ƒå˜é‡å¯ç”¨');
      } else {
        console.warn('Vite ç¯å¢ƒå˜é‡ä¸å¯ç”¨ï¼Œå¯èƒ½æœªåœ¨ Vite ç¯å¢ƒä¸­è¿è¡Œ');
      }
      
      // ç»‘å®šæŒ‰é’®äº‹ä»¶
      document.getElementById('check-env-btn').addEventListener('click', checkEnvironment);
      document.getElementById('test-db-btn').addEventListener('click', testDatabaseConnection);
      document.getElementById('show-instructions-btn').addEventListener('click', showSetupInstructions);
      
      checkEnvironment();
    });

    // æ·»åŠ é”™è¯¯å¤„ç†
    window.addEventListener('error', (event) => {
      console.error('å…¨å±€é”™è¯¯:', event.error);
      const resultsDiv = document.getElementById('test-results');
      if (resultsDiv) {
        resultsDiv.innerHTML = `
          <div class="status-card error">
            <h3>âŒ è¿è¡Œæ—¶é”™è¯¯</h3>
            <p>é”™è¯¯ä¿¡æ¯ï¼š${event.error.message}</p>
            <p>è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯ã€‚</p>
          </div>
        `;
        resultsDiv.style.display = 'block';
      }
    });
  </script>
</body>
</html>