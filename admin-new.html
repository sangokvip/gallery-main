<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç®¡ç†å‘˜åå° - æ–°ç‰ˆæœ¬ - M-Profile Lab</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      color: white;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 30px;
      backdrop-filter: blur(10px);
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .status-info {
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin: 10px;
      transition: all 0.3s ease;
      font-size: 16px;
    }
    .btn-primary {
      background: #1976d2;
      color: white;
    }
    .btn-primary:hover {
      background: #1565c0;
      transform: translateY(-2px);
    }
    .btn-success {
      background: #4caf50;
      color: white;
    }
    .btn-success:hover {
      background: #45a049;
      transform: translateY(-2px);
    }
    .btn-warning {
      background: #ff9800;
      color: white;
    }
    .btn-warning:hover {
      background: #f57c00;
      transform: translateY(-2px);
    }
    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    .feature-card {
      background: rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 25px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.3);
      transition: all 0.3s ease;
    }
    .feature-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .feature-icon {
      font-size: 3em;
      margin-bottom: 15px;
    }
    .warning-box {
      background: rgba(255, 152, 0, 0.2);
      border: 2px solid #ff9800;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }
    .success-box {
      background: rgba(76, 175, 80, 0.2);
      border: 2px solid #4caf50;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }
    .code-block {
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ M-Profile Lab ç®¡ç†å‘˜åå°</h1>
    
    <div class="status-info">
      <h2>ğŸ¯ æ–°ç‰ˆæœ¬ç®¡ç†å‘˜ç•Œé¢</h2>
      <p>æ­¤é¡µé¢ä½¿ç”¨å…¨æ–°çš„ç»Ÿè®¡æŸ¥è¯¢é€»è¾‘ï¼ŒåŸºäº test-stats-fix.html çš„æˆåŠŸæ–¹æ³•</p>
    </div>

    <div class="feature-grid">
      <div class="feature-card">
        <div class="feature-icon">ğŸ“Š</div>
        <h3>å…¨æ–°ç»Ÿè®¡ç³»ç»Ÿ</h3>
        <p>ä½¿ç”¨ test-stats-fix.html éªŒè¯è¿‡çš„æŸ¥è¯¢æ–¹æ³•ï¼Œç¡®ä¿ç»Ÿè®¡æ•°æ®å‡†ç¡®æ˜¾ç¤º</p>
      </div>
      
      <div class="feature-card">
        <div class="feature-icon">ğŸ”§</div>
        <h3>ç®€åŒ–æŸ¥è¯¢é€»è¾‘</h3>
        <p>ç§»é™¤å¤æ‚çš„ head: true å‚æ•°ï¼Œä½¿ç”¨æ›´ç¨³å®šçš„ select('id', { count: 'exact' })</p>
      </div>
      
      <div class="feature-card">
        <div class="feature-icon">ğŸ›¡ï¸</div>
        <h3>å®¹é”™å¤„ç†</h3>
        <p>å¤šé‡å¤‡ç”¨æ–¹æ¡ˆï¼Œç¡®ä¿åœ¨å„ç§æƒ…å†µä¸‹éƒ½èƒ½æ­£ç¡®æ˜¾ç¤ºæ•°æ®</p>
      </div>
      
      <div class="feature-card">
        <div class="feature-icon">ğŸ“ˆ</div>
        <h3>å®æ—¶æ›´æ–°</h3>
        <p>æ”¯æŒå®æ—¶æ•°æ®åˆ·æ–°ï¼ŒåŠ¨æ€æ˜¾ç¤ºæœ€æ–°çš„ç»Ÿè®¡æ•°æ®</p>
      </div>
    </div>

    <div class="warning-box">
      <h3>âš ï¸ ä½¿ç”¨å‰è¯·ç¡®è®¤</h3>
      <p>è¯·ç¡®ä¿æ‚¨å·²ç»é…ç½®äº†æ­£ç¡®çš„ç¯å¢ƒå˜é‡ï¼š</p>
      <div class="code-block">
VITE_SUPABASE_URL=your-supabase-url
VITE_SUPABASE_ANON_KEY=your-anon-key
      </div>
    </div>

    <div style="text-align: center; margin: 30px 0;">
      <button class="btn btn-success" onclick="launchNewAdmin()">
        ğŸš€ å¯åŠ¨æ–°ç®¡ç†å‘˜ç•Œé¢
      </button>
      <button class="btn btn-primary" onclick="testStatsOnly()">
        ğŸ“Š ä»…æµ‹è¯•ç»Ÿè®¡åŠŸèƒ½
      </button>
      <button class="btn btn-warning" onclick="showIntegrationGuide()">
        ğŸ“– æŸ¥çœ‹é›†æˆæŒ‡å—
      </button>
    </div>

    <div id="results" style="display: none;">
      <!-- æµ‹è¯•ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
    </div>

    <div id="integration-guide" style="display: none;">
      <h3>ğŸ”§ é›†æˆæŒ‡å—</h3>
      <p>è¦å°†æ–°çš„ç®¡ç†å‘˜ç•Œé¢é›†æˆåˆ°æ‚¨çš„ä¸»åº”ç”¨ä¸­ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š</p>
      
      <h4>æ­¥éª¤1: å¤‡ä»½åŸæ–‡ä»¶</h4>
      <div class="code-block">
# å¤‡ä»½åŸå§‹æ–‡ä»¶
cp src/AdminApp.jsx src/AdminApp-old.jsx
cp admin.html admin-old.html
      </div>
      
      <h4>æ­¥éª¤2: ä½¿ç”¨æ–°æ–‡ä»¶</h4>
      <div class="code-block">
# ä½¿ç”¨æ–°çš„ç®¡ç†å‘˜ç»„ä»¶
cp src/AdminApp-new.jsx src/AdminApp.jsx

# æˆ–è€…åˆ›å»ºæ–°çš„å…¥å£æ–‡ä»¶
cp admin-new.html admin.html
      </div>
      
      <h4>æ­¥éª¤3: éªŒè¯åŠŸèƒ½</h4>
      <p>é‡æ–°å¯åŠ¨åº”ç”¨å¹¶è®¿é—®ç®¡ç†å‘˜ç•Œé¢ï¼Œç¡®è®¤ç»Ÿè®¡æ•°æ®æ­£ç¡®æ˜¾ç¤ºã€‚</p>
      
      <h4>å…³é”®æ”¹è¿›ç‚¹</h4>
      <ul style="text-align: left;">
        <li><strong>ç®€åŒ–æŸ¥è¯¢é€»è¾‘</strong>: ä½¿ç”¨ select('id', { count: 'exact' }) æ›¿ä»£å¤æ‚çš„ head: true</li>
        <li><strong>å¢å¼ºé”™è¯¯å¤„ç†</strong>: å¤šé‡å¤‡ç”¨æ–¹æ¡ˆç¡®ä¿æ•°æ®å¯é æ€§</li>
        <li><strong>ä¼˜åŒ–æ€§èƒ½</strong>: å‡å°‘ä¸å¿…è¦çš„æ•°æ®åº“æŸ¥è¯¢å’Œæ•°æ®å¤„ç†</li>
        <li><strong>æ›´å¥½çš„æ—¥å¿—</strong>: è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ä¾¿äºé—®é¢˜æ’æŸ¥</li>
      </ul>
    </div>
  </div>

  <script type="module">
    let supabase;

    // æ£€æŸ¥ç¯å¢ƒ
    async function checkEnvironment() {
      const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
      const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
      
      if (!supabaseUrl || !supabaseKey) {
        showResults(`
          <div class="warning-box">
            <h3>âŒ ç¯å¢ƒå˜é‡æœªé…ç½®</h3>
            <p>VITE_SUPABASE_URL: ${supabaseUrl ? 'å·²é…ç½®' : 'æœªé…ç½®'}</p>
            <p>VITE_SUPABASE_ANON_KEY: ${supabaseKey ? 'å·²é…ç½®' : 'æœªé…ç½®'}</p>
            <p>è¯·å…ˆé…ç½®ç¯å¢ƒå˜é‡å†æµ‹è¯•ã€‚</p>
          </div>
        `, 'error');
        return false;
      }
      
      try {
        const { createClient } = await import('https://esm.sh/@supabase/supabase-js');
        supabase = createClient(supabaseUrl, supabaseKey);
        
        // æµ‹è¯•è¿æ¥
        const { data, error } = await supabase.from('users').select('id').limit(1);
        if (error) {
          showResults(`
            <div class="warning-box">
              <h3>âŒ æ•°æ®åº“è¿æ¥å¤±è´¥</h3>
              <p>é”™è¯¯: ${error.message}</p>
              <p>è¯·æ£€æŸ¥æ•°æ®åº“é…ç½®å’Œç½‘ç»œè¿æ¥ã€‚</p>
            </div>
          `, 'error');
          return false;
        }
        
        return true;
      } catch (error) {
        showResults(`
          <div class="warning-box">
            <h3>âŒ ç¯å¢ƒæ£€æŸ¥å¤±è´¥</h3>
            <p>é”™è¯¯: ${error.message}</p>
          </div>
        `, 'error');
        return false;
      }
    }

    // æµ‹è¯•ç»Ÿè®¡åŠŸèƒ½
    async function testStatsOnly() {
      showResults('<div class="status-info"><h3>ğŸ”„ æ­£åœ¨æµ‹è¯•ç»Ÿè®¡åŠŸèƒ½...</h3><p>è¯·ç¨å€™...</p></div>');
      
      if (!await checkEnvironment()) return;
      
      try {
        // ä½¿ç”¨æ–°çš„ç»Ÿè®¡æ–¹æ³•
        const queries = [
          supabase.from('users').select('id', { count: 'exact' }),
          supabase.from('test_records').select('id', { count: 'exact' }),
          supabase.from('messages').select('id', { count: 'exact' }),
          supabase.from('users').select('id', { count: 'exact' }).gte('last_active', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString()),
          supabase.from('test_records').select('id', { count: 'exact' }).gte('created_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString())
        ];
        
        const results = await Promise.allSettled(queries);
        
        const stats = {
          totalUsers: results[0].status === 'fulfilled' ? results[0].value.count : 0,
          totalTests: results[1].status === 'fulfilled' ? results[1].value.count : 0,
          totalMessages: results[2].status === 'fulfilled' ? results[2].value.count : 0,
          todayUsers: results[3].status === 'fulfilled' ? results[3].value.count : 0,
          todayTests: results[4].status === 'fulfilled' ? results[4].value.count : 0
        };
        
        // å¯¹æ¯”æµ‹è¯„è®°å½•æŸ¥è¯¢
        const { data, error, count } = await supabase
          .from('test_records')
          .select('*', { count: 'exact' })
          .limit(1);
        
        const comparisonCount = count || 0;
        const isConsistent = stats.totalTests === comparisonCount;
        
        showResults(`
          <div class="${isConsistent ? 'success-box' : 'warning-box'}">
            <h3>${isConsistent ? 'âœ… ç»Ÿè®¡åŠŸèƒ½æ­£å¸¸' : 'âš ï¸ å­˜åœ¨å·®å¼‚'}</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
              <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                <h4>æ€»ç”¨æˆ·æ•°</h4>
                <div style="font-size: 2em; font-weight: bold;">${stats.totalUsers}</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                <h4>æ€»æµ‹è¯•æ•°</h4>
                <div style="font-size: 2em; font-weight: bold;">${stats.totalTests}</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                <h4>æ€»ç•™è¨€æ•°</h4>
                <div style="font-size: 2em; font-weight: bold;">${stats.totalMessages}</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                <h4>ä»Šæ—¥ç”¨æˆ·</h4>
                <div style="font-size: 2em; font-weight: bold;">${stats.todayUsers}</div>
              </div>
              <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                <h4>ä»Šæ—¥æµ‹è¯•</h4>
                <div style="font-size: 2em; font-weight: bold;">${stats.todayTests}</div>
              </div>
            </div>
            <p><strong>å¯¹æ¯”éªŒè¯:</strong> æµ‹è¯„è®°å½•æŸ¥è¯¢è¿”å› ${comparisonCount} æ¡è®°å½•</p>
            <p><strong>ä¸€è‡´æ€§:</strong> ${isConsistent ? 'âœ… å®Œç¾åŒ¹é…' : 'âš ï¸ å­˜åœ¨å·®å¼‚ï¼Œéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥'}</p>
            <p><strong>çŠ¶æ€:</strong> ${stats.totalTests > 0 ? 'âœ… ç»Ÿè®¡æ•°æ®æ­£å¸¸æ˜¾ç¤º' : 'âš ï¸ æš‚æ— æµ‹è¯•æ•°æ®'}</p>
          </div>
        `, isConsistent ? 'success' : 'warning');
        
      } catch (error) {
        showResults(`
          <div class="warning-box">
            <h3>âŒ ç»Ÿè®¡æµ‹è¯•å¤±è´¥</h3>
            <p>é”™è¯¯: ${error.message}</p>
            <p>è¯·æ£€æŸ¥æ•°æ®åº“è¿æ¥å’Œè¡¨ç»“æ„ã€‚</p>
          </div>
        `, 'error');
      }
    }

    // å¯åŠ¨æ–°ç®¡ç†å‘˜ç•Œé¢
    async function launchNewAdmin() {
      showResults('<div class="status-info"><h3>ğŸš€ æ­£åœ¨å¯åŠ¨æ–°ç®¡ç†å‘˜ç•Œé¢...</h3><p>è¯·ç¨å€™...</p></div>');
      
      if (!await checkEnvironment()) return;
      
      try {
        // æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
        await testStatsOnly();
        
        showResults(`
          <div class="success-box">
            <h3>âœ… æ–°ç®¡ç†å‘˜ç•Œé¢å°±ç»ª</h3>
            <p>ç»Ÿè®¡åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼Œå¯ä»¥å®‰å…¨ä½¿ç”¨æ–°çš„ç®¡ç†å‘˜ç•Œé¢ã€‚</p>
            <div style="margin: 20px 0;">
              <h4>ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ:</h4>
              <ol style="text-align: left;">
                <li>å¤‡ä»½åŸå§‹æ–‡ä»¶: <code>cp src/AdminApp.jsx src/AdminApp-old.jsx</code></li>
                <li>ä½¿ç”¨æ–°æ–‡ä»¶: <code>cp src/AdminApp-new.jsx src/AdminApp.jsx</code></li>
                <li>é‡å¯å¼€å‘æœåŠ¡å™¨: <code>npm run dev</code></li>
                <li>è®¿é—®ç®¡ç†å‘˜ç•Œé¢éªŒè¯åŠŸèƒ½</li>
              </ol>
            </div>
            <button class="btn btn-success" onclick="showIntegrationGuide()">
              ğŸ“– æŸ¥çœ‹è¯¦ç»†é›†æˆæŒ‡å—
            </button>
          </div>
        `, 'success');
        
      } catch (error) {
        showResults(`
          <div class="warning-box">
            <h3>âŒ å¯åŠ¨å¤±è´¥</h3>
            <p>é”™è¯¯: ${error.message}</p>
            <p>è¯·å…ˆè§£å†³ä¸Šè¿°é—®é¢˜å†å°è¯•é›†æˆã€‚</p>
          </div>
        `, 'error');
      }
    }

    // æ˜¾ç¤ºé›†æˆæŒ‡å—
    function showIntegrationGuide() {
      const guide = document.getElementById('integration-guide');
      guide.style.display = guide.style.display === 'none' ? 'block' : 'none';
    }

    // æ˜¾ç¤ºç»“æœ
    function showResults(html, type = 'info') {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = html;
      resultsDiv.style.display = 'block';
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    document.addEventListener('DOMContentLoaded', () => {
      console.log('æ–°ç®¡ç†å‘˜ç•Œé¢æµ‹è¯•å·¥å…·å·²åŠ è½½');
    });

    // æš´éœ²å…¨å±€å‡½æ•°
    window.testStatsOnly = testStatsOnly;
    window.launchNewAdmin = launchNewAdmin;
    window.showIntegrationGuide = showIntegrationGuide;
  </script>
</body>
</html>