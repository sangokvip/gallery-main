<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç®¡ç†å‘˜åå°ä¿®å¤éªŒè¯</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      color: white;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 30px;
      backdrop-filter: blur(10px);
    }
    .test-section {
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      padding: 20px;
      margin: 15px 0;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin: 5px;
      transition: all 0.3s ease;
    }
    .btn-primary {
      background: #1976d2;
      color: white;
    }
    .btn-primary:hover {
      background: #1565c0;
    }
    .btn-secondary {
      background: #4caf50;
      color: white;
    }
    .btn-secondary:hover {
      background: #45a049;
    }
    .result-display {
      background: rgba(0,0,0,0.3);
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
    .success { color: #4caf50; }
    .error { color: #f44336; }
    .warning { color: #ff9800; }
    .info { color: #2196f3; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ ç®¡ç†å‘˜åå°ä¿®å¤éªŒè¯</h1>
    
    <div class="test-section">
      <h3>ä¿®å¤éªŒè¯</h3>
      <p>è¿™ä¸ªå·¥å…·å°†éªŒè¯ç®¡ç†å‘˜åå°çš„ä¿®å¤æ˜¯å¦æˆåŠŸ</p>
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="testFunctionCalls()">æµ‹è¯•å‡½æ•°è°ƒç”¨</button>
        <button class="btn btn-secondary" onclick="testDataLoading()">æµ‹è¯•æ•°æ®åŠ è½½</button>
        <button class="btn btn-secondary" onclick="verifyFix()">éªŒè¯ä¿®å¤</button>
      </div>
    </div>

    <div class="test-section">
      <h3>æµ‹è¯•ç»“æœ</h3>
      <div id="test-results">
        <p style="text-align: center; color: #666;">ç­‰å¾…æµ‹è¯•ç»“æœ...</p>
      </div>
    </div>

    <div class="test-section">
      <h3>ä¿®å¤çŠ¶æ€</h3>
      <div id="fix-status">
        <span class="status-indicator status-info"></span>
        å‡†å¤‡éªŒè¯ä¿®å¤...
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './src/utils/supabase.js';
    
    let testResults = {};

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const resultsDiv = document.getElementById('test-results');
      const colorClass = type === 'error' ? 'error-text' : type === 'success' ? 'success-text' : type === 'warning' ? 'warning-text' : '';
      resultsDiv.innerHTML += `<div class="result-display">[${timestamp}] <span class="${colorClass}">${message}</span></div>`;
      console.log(`[${timestamp}] ${message}`);
    }

    function updateStatus(elementId, message, type = 'info') {
      const element = document.getElementById(elementId);
      const statusIcon = type === 'success' ? 'status-success' : 
                        type === 'error' ? 'status-error' : 
                        type === 'warning' ? 'status-warning' : 'status-info';
      element.innerHTML = `<span class="status-indicator ${statusIcon}"></span>${message}`;
    }

    // æµ‹è¯•å‡½æ•°è°ƒç”¨
    window.testFunctionCalls = async function() {
      log('å¼€å§‹æµ‹è¯•å‡½æ•°è°ƒç”¨...', 'info');
      
      try {
        // æµ‹è¯•ç³»ç»Ÿç»Ÿè®¡å‡½æ•°
        log('æµ‹è¯•ç³»ç»Ÿç»Ÿè®¡æŸ¥è¯¢...', 'info');
        const { data: users, error: usersError } = await supabase
          .from('users')
          .select('*', { count: 'exact', head: true });
        
        if (usersError) {
          throw new Error(`ç”¨æˆ·ç»Ÿè®¡å¤±è´¥: ${usersError.message}`);
        }
        
        log(`âœ… ç”¨æˆ·ç»Ÿè®¡æˆåŠŸ: ${users.count} ä¸ªç”¨æˆ·`, 'success');
        
        // æµ‹è¯•æµ‹è¯•è®°å½•æŸ¥è¯¢
        log('æµ‹è¯•æµ‹è¯•è®°å½•æŸ¥è¯¢...', 'info');
        const { data: records, error: recordsError } = await supabase
          .from('test_records')
          .select('*', { count: 'exact', head: true });
        
        if (recordsError) {
          throw new Error(`æµ‹è¯•è®°å½•ç»Ÿè®¡å¤±è´¥: ${recordsError.message}`);
        }
        
        log(`âœ… æµ‹è¯•è®°å½•ç»Ÿè®¡æˆåŠŸ: ${records.count} æ¡è®°å½•`, 'success');
        
        // æµ‹è¯•IPåœ°å€æŸ¥è¯¢
        log('æµ‹è¯•IPåœ°å€æŸ¥è¯¢...', 'info');
        const { data: ips, error: ipsError } = await supabase
          .from('user_ips')
          .select('*')
          .limit(5);
        
        if (ipsError) {
          throw new Error(`IPåœ°å€æŸ¥è¯¢å¤±è´¥: ${ipsError.message}`);
        }
        
        log(`âœ… IPåœ°å€æŸ¥è¯¢æˆåŠŸ: ${ips ? ips.length : 0} æ¡è®°å½•`, 'success');
        
        updateStatus('fix-status', 'âœ… æ‰€æœ‰å‡½æ•°è°ƒç”¨æµ‹è¯•é€šè¿‡', 'success');
        
      } catch (error) {
        log(`âŒ å‡½æ•°è°ƒç”¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        updateStatus('fix-status', 'âŒ å‡½æ•°è°ƒç”¨æµ‹è¯•å¤±è´¥', 'error');
      }
    }

    // æµ‹è¯•æ•°æ®åŠ è½½
    window.testDataLoading = async function() {
      log('å¼€å§‹æµ‹è¯•æ•°æ®åŠ è½½åŠŸèƒ½...', 'info');
      
      try {
        // æ¨¡æ‹Ÿå®Œæ•´çš„ä»ªè¡¨æ¿æ•°æ®åŠ è½½æµç¨‹
        log('æ¨¡æ‹Ÿä»ªè¡¨æ¿æ•°æ®åŠ è½½æµç¨‹...', 'info');
        
        // 1. ç³»ç»Ÿç»Ÿè®¡
        const statsResults = await Promise.allSettled([
          supabase.from('users').select('*', { count: 'exact', head: true }),
          supabase.from('test_records').select('*', { count: 'exact', head: true }),
          supabase.from('test_records').select('*', { count: 'exact', head: true }).gte('created_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString()),
          supabase.from('test_records').select('test_type, count(*)').group('test_type')
        ]);
        
        const [usersResult, recordsResult, todayResult, typesResult] = statsResults;
        
        const stats = {
          totalUsers: usersResult.status === 'fulfilled' ? usersResult.value.count : 0,
          totalRecords: recordsResult.status === 'fulfilled' ? recordsResult.value.count : 0,
          todayRecords: todayResult.status === 'fulfilled' ? todayResult.value.count : 0,
          testTypes: typesResult.status === 'fulfilled' ? typesResult.value.data : []
        };
        
        log(`âœ… ç³»ç»Ÿç»Ÿè®¡åŠ è½½æˆåŠŸ`, 'success');
        log(`   ç”¨æˆ·æ•°: ${stats.totalUsers}, æµ‹è¯•è®°å½•: ${stats.totalRecords}, ä»Šæ—¥: ${stats.todayRecords}`, 'info');
        
        // 2. æµ‹è¯•è®°å½•åˆ—è¡¨
        log('åŠ è½½æµ‹è¯•è®°å½•åˆ—è¡¨...', 'info');
        const { data: records, error: recordsError } = await supabase
          .from('test_records')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(10);
        
        if (recordsError) {
          throw new Error(`æµ‹è¯•è®°å½•åŠ è½½å¤±è´¥: ${recordsError.message}`);
        }
        
        log(`âœ… æµ‹è¯•è®°å½•åŠ è½½æˆåŠŸ: ${records ? records.length : 0} æ¡è®°å½•`, 'success');
        
        // 3. IPåœ°å€åˆ—è¡¨
        log('åŠ è½½IPåœ°å€åˆ—è¡¨...', 'info');
        const { data: ips, error: ipsError } = await supabase
          .from('user_ips')
          .select('*')
          .order('last_seen', { ascending: false })
          .limit(10);
        
        if (ipsError) {
          throw new Error(`IPåœ°å€åŠ è½½å¤±è´¥: ${ipsError.message}`);
        }
        
        log(`âœ… IPåœ°å€åŠ è½½æˆåŠŸ: ${ips ? ips.length : 0} æ¡è®°å½•`, 'success');
        
        updateStatus('fix-status', 'âœ… æ•°æ®åŠ è½½åŠŸèƒ½æµ‹è¯•é€šè¿‡', 'success');
        
      } catch (error) {
        log(`âŒ æ•°æ®åŠ è½½æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        updateStatus('fix-status', 'âŒ æ•°æ®åŠ è½½æµ‹è¯•å¤±è´¥', 'error');
      }
    }

    // éªŒè¯ä¿®å¤
    window.verifyFix = async function() {
      log('å¼€å§‹éªŒè¯ä¿®å¤ç»“æœ...', 'info');
      
      try {
        // éªŒè¯æ•°æ®åº“è¿æ¥
        const { data, error } = await supabase
          .from('test_records')
          .select('id')
          .limit(1);
        
        if (error) {
          throw new Error(`æ•°æ®åº“è¿æ¥éªŒè¯å¤±è´¥: ${error.message}`);
        }
        
        log('âœ… æ•°æ®åº“è¿æ¥éªŒè¯é€šè¿‡', 'success');
        
        // éªŒè¯å‡½æ•°å­˜åœ¨æ€§ï¼ˆé€šè¿‡æŸ¥è¯¢æˆåŠŸæ¥åˆ¤æ–­ï¼‰
        const checks = [
          { name: 'ç³»ç»Ÿç»Ÿè®¡', func: () => supabase.from('users').select('*', { count: 'exact', head: true }) },
          { name: 'æµ‹è¯•è®°å½•', func: () => supabase.from('test_records').select('*', { count: 'exact', head: true }) },
          { name: 'IPåœ°å€', func: () => supabase.from('user_ips').select('*').limit(1) }
        ];
        
        for (const check of checks) {
          try {
            const { error } = await check.func();
            if (error) {
              throw new Error(`${check.name} éªŒè¯å¤±è´¥: ${error.message}`);
            }
            log(`âœ… ${check.name} éªŒè¯é€šè¿‡`, 'success');
          } catch (err) {
            log(`âŒ ${check.name} éªŒè¯å¤±è´¥: ${err.message}`, 'error');
          }
        }
        
        updateStatus('fix-status', 'âœ… ä¿®å¤éªŒè¯é€šè¿‡', 'success');
        log('ğŸ‰ æ‰€æœ‰ä¿®å¤éªŒè¯å®Œæˆï¼ç®¡ç†å‘˜åå°åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œäº†', 'success');
        
      } catch (error) {
        log(`âŒ ä¿®å¤éªŒè¯å¤±è´¥: ${error.message}`, 'error');
        updateStatus('fix-status', 'âŒ ä¿®å¤éªŒè¯å¤±è´¥', 'error');
      }
    }

    // åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      console.log('ä¿®å¤éªŒè¯å·¥å…·å·²åŠ è½½');
      log('ä¿®å¤éªŒè¯å·¥å…·åˆå§‹åŒ–å®Œæˆ', 'success');
    });
  </script>
</body>
</html>