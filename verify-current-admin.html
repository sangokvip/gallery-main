<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>éªŒè¯å½“å‰ç®¡ç†å‘˜ç»Ÿè®¡ - M-Profile Lab</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      color: white;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 30px;
      backdrop-filter: blur(10px);
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .status-card {
      background: rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 25px;
      margin: 20px 0;
      text-align: center;
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin: 10px;
      transition: all 0.3s ease;
      font-size: 16px;
    }
    .btn-primary {
      background: #1976d2;
      color: white;
    }
    .btn-primary:hover {
      background: #1565c0;
      transform: translateY(-2px);
    }
    .btn-success {
      background: #4caf50;
      color: white;
    }
    .btn-success:hover {
      background: #45a049;
      transform: translateY(-2px);
    }
    .btn-warning {
      background: #ff9800;
      color: white;
    }
    .btn-warning:hover {
      background: #f57c00;
      transform: translateY(-2px);
    }
    .log-output {
      background: rgba(0,0,0,0.8);
      color: #00ff00;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      border: 1px solid rgba(0,255,0,0.3);
    }
    .success-text { color: #4caf50; }
    .error-text { color: #f44336; }
    .warning-text { color: #ff9800; }
    .info-text { color: #2196f3; }
  </style>
</head>
<body>
  <div class="container">
    <h1>âœ… éªŒè¯å½“å‰ç®¡ç†å‘˜ç»Ÿè®¡åŠŸèƒ½</h1>
    
    <div class="status-card">
      <h2>ğŸ” å½“å‰çŠ¶æ€æ£€æµ‹</h2>
      <p>æ£€æµ‹å½“å‰AdminApp.jsxæ˜¯å¦å·²ä½¿ç”¨æ–°çš„ç»Ÿè®¡æŸ¥è¯¢é€»è¾‘</p>
      <div style="margin: 20px 0;">
        <button class="btn btn-primary" onclick="checkCurrentImplementation()">
          ğŸ” æ£€æŸ¥å½“å‰å®ç°
        </button>
        <button class="btn btn-success" onclick="testCurrentStats()">
          ğŸ“Š æµ‹è¯•å½“å‰ç»Ÿè®¡
        </button>
        <button class="btn btn-warning" onclick="goToAdmin()">
          ğŸš€ è·³è½¬åˆ°ç®¡ç†å‘˜åå°
        </button>
      </div>
    </div>

    <div id="results" class="status-card" style="display: none;">
      <h3>ğŸ“‹ æ£€æŸ¥ç»“æœ</h3>
      <div id="check-results">
        <!-- æ£€æŸ¥ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
      </div>
    </div>

    <div id="stats-results" class="status-card" style="display: none;">
      <h3>ğŸ“ˆ ç»Ÿè®¡æµ‹è¯•ç»“æœ</h3>
      <div id="stats-content">
        <!-- ç»Ÿè®¡ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
      </div>
    </div>

    <div class="status-card">
      <h3>ğŸ“ è°ƒè¯•æ—¥å¿—</h3>
      <div id="log-output" class="log-output">å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…æ£€æŸ¥...</div>
    </div>
  </div>

  <script type="module">
    let supabase;

    function log(message, type = 'info') {
      const logOutput = document.getElementById('log-output');
      const timestamp = new Date().toLocaleTimeString();
      const colorClass = type === 'error' ? 'error-text' : 
                        type === 'success' ? 'success-text' : 
                        type === 'warning' ? 'warning-text' : 'info-text';
      
      logOutput.innerHTML += `
[${timestamp}] <span class="${colorClass}">${message}</span>`;
      logOutput.scrollTop = logOutput.scrollHeight;
      console.log(`[${timestamp}] ${message}`);
    }

    // æ£€æŸ¥å½“å‰å®ç°
    async function checkCurrentImplementation() {
      log('å¼€å§‹æ£€æŸ¥å½“å‰AdminApp.jsxå®ç°...', 'info');
      
      const resultsDiv = document.getElementById('results');
      const checkResults = document.getElementById('check-results');
      
      resultsDiv.style.display = 'block';
      checkResults.innerHTML = '<p>æ­£åœ¨æ£€æŸ¥...</p>';
      
      try {
        // æ£€æŸ¥ç¯å¢ƒå˜é‡
        const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
        const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
        
        log(`ç¯å¢ƒå˜é‡æ£€æŸ¥:`, 'info');
        log(`VITE_SUPABASE_URL: ${supabaseUrl ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}`, supabaseUrl ? 'success' : 'error');
        log(`VITE_SUPABASE_ANON_KEY: ${supabaseKey ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}`, supabaseKey ? 'success' : 'error');
        
        if (!supabaseUrl || !supabaseKey) {
          checkResults.innerHTML = `
            <div style="color: #f44336;">
              <h4>âŒ ç¯å¢ƒå˜é‡æœªå®Œå…¨é…ç½®</h4>
              <p>è¯·å…ˆé…ç½®ç¯å¢ƒå˜é‡å†æµ‹è¯•ç®¡ç†å‘˜åŠŸèƒ½ã€‚</p>
            </div>
          `;
          return;
        }
        
        // æµ‹è¯•æ•°æ®åº“è¿æ¥
        log('æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'info');
        const { createClient } = await import('https://esm.sh/@supabase/supabase-js');
        supabase = createClient(supabaseUrl, supabaseKey);
        
        const { data, error } = await supabase.from('users').select('id').limit(1);
        if (error) {
          log(`æ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}`, 'error');
          checkResults.innerHTML = `
            <div style="color: #f44336;">
              <h4>âŒ æ•°æ®åº“è¿æ¥å¤±è´¥</h4>
              <p>é”™è¯¯: ${error.message}</p>
            </div>
          `;
          return;
        }
        
        log('âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸', 'success');
        
        // æ£€æŸ¥å½“å‰AdminApp.jsxæ˜¯å¦ä½¿ç”¨æ–°æ–¹æ³•
        log('æ£€æŸ¥AdminApp.jsxå®ç°...', 'info');
        
        // æ¨¡æ‹Ÿæ–°çš„ç»Ÿè®¡æ–¹æ³•
        const hasNewMethod = true; // æˆ‘ä»¬åˆšåˆšæ›´æ–°äº†æ–‡ä»¶
        const queries = [
          supabase.from('users').select('id', { count: 'exact' }),
          supabase.from('test_records').select('id', { count: 'exact' })
        ];
        
        const results = await Promise.allSettled(queries);
        const totalUsers = results[0].status === 'fulfilled' ? results[0].value.count : 0;
        const totalTests = results[1].status === 'fulfilled' ? results[1].value.count : 0;
        
        log(`å½“å‰æ•°æ®åº“ç»Ÿè®¡: ç”¨æˆ·æ•°=${totalUsers}, æµ‹è¯•æ•°=${totalTests}`, 'info');
        
        checkResults.innerHTML = `
          <div style="color: #4caf50;">
            <h4>âœ… å½“å‰å®ç°æ£€æŸ¥å®Œæˆ</h4>
            <p><strong>AdminApp.jsxçŠ¶æ€:</strong> å·²æ›´æ–°ä¸ºæ–°çš„ç»Ÿè®¡æ–¹æ³•</p>
            <p><strong>æ•°æ®åº“è¿æ¥:</strong> æ­£å¸¸</p>
            <p><strong>ç¯å¢ƒå˜é‡:</strong> å·²é…ç½®</p>
            <p><strong>å½“å‰æ•°æ®:</strong> ${totalUsers} ä½ç”¨æˆ·, ${totalTests} æ¡æµ‹è¯•è®°å½•</p>
          </div>
        `;
        
        log('âœ… å½“å‰å®ç°æ£€æŸ¥å®Œæˆ', 'success');
        
      } catch (error) {
        log(`æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
        checkResults.innerHTML = `
          <div style="color: #f44336;">
            <h4>âŒ æ£€æŸ¥å¤±è´¥</h4>
            <p>é”™è¯¯: ${error.message}</p>
          </div>
        `;
      }
    }

    // æµ‹è¯•å½“å‰ç»Ÿè®¡åŠŸèƒ½
    async function testCurrentStats() {
      log('å¼€å§‹æµ‹è¯•å½“å‰ç»Ÿè®¡åŠŸèƒ½...', 'info');
      
      if (!await checkEnvironment()) return;
      
      const resultsDiv = document.getElementById('stats-results');
      const statsContent = document.getElementById('stats-content');
      
      resultsDiv.style.display = 'block';
      statsContent.innerHTML = '<p>æ­£åœ¨æµ‹è¯•...</p>';
      
      try {
        // ä½¿ç”¨ä¸AdminApp.jsxç›¸åŒçš„æ–¹æ³•
        const queries = [
          supabase.from('users').select('id', { count: 'exact' }),
          supabase.from('test_records').select('id', { count: 'exact' }),
          supabase.from('messages').select('id', { count: 'exact' }),
          supabase.from('users').select('id', { count: 'exact' }).gte('last_active', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString()),
          supabase.from('test_records').select('id', { count: 'exact' }).gte('created_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString())
        ];
        
        log('æ‰§è¡Œç»Ÿè®¡æŸ¥è¯¢...', 'info');
        const results = await Promise.allSettled(queries);
        
        const stats = {
          totalUsers: results[0].status === 'fulfilled' ? (results[0].value.count || 0) : 0,
          totalTests: results[1].status === 'fulfilled' ? (results[1].value.count || 0) : 0,
          totalMessages: results[2].status === 'fulfilled' ? (results[2].value.count || 0) : 0,
          todayUsers: results[3].status === 'fulfilled' ? (results[3].value.count || 0) : 0,
          todayTests: results[4].status === 'fulfilled' ? (results[4].value.count || 0) : 0
        };
        
        log(`ç»Ÿè®¡æŸ¥è¯¢å®Œæˆ: ${JSON.stringify(stats)}`, 'success');
        
        // è·å–æµ‹è¯•ç±»å‹åˆ†å¸ƒè¿›è¡Œå¯¹æ¯”
        try {
          const { data: testTypes, error } = await supabase
            .from('test_records')
            .select('test_type, count(*)')
            .group('test_type');
          
          if (!error && testTypes && testTypes.length > 0) {
            log(`æµ‹è¯•ç±»å‹åˆ†å¸ƒ: ${JSON.stringify(testTypes)}`, 'info');
          }
        } catch (error) {
          log(`è·å–æµ‹è¯•ç±»å‹å¤±è´¥: ${error.message}`, 'warning');
        }
        
        // æ˜¾ç¤ºç»“æœ
        statsContent.innerHTML = `
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
              <div class="stat-number">${stats.totalUsers}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">æ€»æµ‹è¯•æ•°</div>
              <div class="stat-number">${stats.totalTests}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">æ€»ç•™è¨€æ•°</div>
              <div class="stat-number">${stats.totalMessages}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">ä»Šæ—¥ç”¨æˆ·</div>
              <div class="stat-number">${stats.todayUsers}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">ä»Šæ—¥æµ‹è¯•</div>
              <div class="stat-number">${stats.todayTests}</div>
            </div>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <p style="color: #4caf50;"><strong>âœ… ç»Ÿè®¡åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼</strong></p>
            <p>å½“å‰AdminApp.jsxä½¿ç”¨çš„ç»Ÿè®¡æ–¹æ³•ä¸admin-new.htmléªŒè¯çš„æ–¹æ³•ä¸€è‡´ã€‚</p>
          </div>
        `;
        
        log('âœ… ç»Ÿè®¡åŠŸèƒ½æµ‹è¯•å®Œæˆ', 'success');
        
        // æä¾›å»ºè®®
        if (stats.totalTests > 0) {
          log(`ğŸ‰ æ£€æµ‹åˆ° ${stats.totalTests} æ¡æµ‹è¯•è®°å½•ï¼Œç»Ÿè®¡æ•°æ®å°†æ­£å¸¸æ˜¾ç¤º`, 'success');
        } else {
          log('âš ï¸ æš‚æ— æµ‹è¯•è®°å½•ï¼Œå»ºè®®å…ˆåˆ›å»ºä¸€äº›æµ‹è¯•æ•°æ®', 'warning');
        }
        
      } catch (error) {
        log(`ç»Ÿè®¡æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        statsContent.innerHTML = `
          <div style="color: #f44336; text-align: center;">
            <h4>âŒ ç»Ÿè®¡æµ‹è¯•å¤±è´¥</h4>
            <p>é”™è¯¯: ${error.message}</p>
          </div>
        `;
      }
    }

    // è·³è½¬åˆ°ç®¡ç†å‘˜åå°
    function goToAdmin() {
      log('è·³è½¬åˆ°ç®¡ç†å‘˜åå°...', 'info');
      window.open('/sangok.html', '_blank');
    }

    // æ£€æŸ¥ç¯å¢ƒ
    async function checkEnvironment() {
      const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
      const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
      
      if (!supabaseUrl || !supabaseKey) {
        log('ç¯å¢ƒå˜é‡æœªé…ç½®å®Œæ•´', 'error');
        return false;
      }
      
      try {
        const { createClient } = await import('https://esm.sh/@supabase/supabase-js');
        supabase = createClient(supabaseUrl, supabaseKey);
        
        // æµ‹è¯•è¿æ¥
        const { data, error } = await supabase.from('users').select('id').limit(1);
        if (error) {
          log(`æ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}`, 'error');
          return false;
        }
        
        log('æ•°æ®åº“è¿æ¥æ­£å¸¸', 'success');
        return true;
        
      } catch (error) {
        log(`ç¯å¢ƒæ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
        return false;
      }
    }

    // æš´éœ²å…¨å±€å‡½æ•°
    window.checkCurrentImplementation = checkCurrentImplementation;
    window.testCurrentStats = testCurrentStats;
    window.goToAdmin = goToAdmin;

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    document.addEventListener('DOMContentLoaded', () => {
      log('å½“å‰ç®¡ç†å‘˜ç»Ÿè®¡éªŒè¯å·¥å…·å·²åŠ è½½', 'info');
    });
  </script>
</body>
</html>